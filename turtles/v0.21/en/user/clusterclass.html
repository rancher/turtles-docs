<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ClusterClass :: Rancher Turtles</title>
    <link rel="prev" href="clusters.html">
    <link rel="next" href="fleet.html">
    <meta name="generator" content="Antora 3.1.9">
    <link rel="stylesheet" href="../../../../_/css/site.css">
<link rel="stylesheet" href="../../../../_/css/search.css">
<link rel="icon" href="../../../../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="../../../../_/css/font-styles.css">
<link rel="stylesheet" href="../../../../_/fonts/css/all.css">
<link rel="stylesheet" href="../../../../_/css/site-extra.css">
<link rel="stylesheet" href="../../../../_/css/vendor/tabs.css">
<!-- <link rel="preconnect" href="https://fonts.gstatic.com"> -->
<link href="https://documentation.suse.com/docserv/res/fonts/poppins/poppins.css" rel="stylesheet">
<!-- <link href="https://fonts.googleapis.com/css?family=Montserrat|Roboto&display=swap" rel="stylesheet"> -->
<link rel="stylesheet" href="../../../../_/css/vendor/light.css">
<script src="/docserv/res/lightheaded/analytics.js"
        type="text/javascript"></script>
<script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js"  type="text/javascript" charset="UTF-8" data-domain-script="0f98beb0-fc4c-417d-a42e-564e2cae42d2" ></script>
<script type="text/javascript">
function OptanonWrapper() { }
</script>
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-57KS2MW');</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <div class="navbar-item">
        <a class=" navbar-logo" href="https://documentation.suse.com/"><img class="logo"
            src="../../../../_/img/logo.svg" /></a>
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
          <div class="navbar-link">
            <img src="../../../../_/img/github_logo.svg" class="langIcon Resurces" alt="Resources" title="Resources">
          </div>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://github.com/rancher/turtles"><i
                class="fab fa-github"></i>&nbsp;Rancher Turtles&nbsp;<i class="fas fa-external-link-alt"></i></a>
            <a class="navbar-item" href="https://github.com/rancher/turtles-docs"><i
                class="fab fa-github"></i>&nbsp;Rancher Turtles docs&nbsp;<i class="fas fa-external-link-alt"></i></a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <div class="navbar-link">More from SUSE</div>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://www.rancher.com" target="_blank"><img src="../../../../_/img/icon-rancher-mask.png" width="51" height="24" alt="Rancher by SUSE"
              title="SUSE Rancher">&nbsp;Rancher&nbsp;<i class="fas fa-external-link-alt"></i></a>
            <hr />
            <a class="navbar-item" href="https://fleet.rancher.io" target="_blank"><img src="../../../../_/img/icon-fleet-mask.png" width="29" height="24" alt="Fleet"
              title="Fleet">&nbsp;Fleet&nbsp;<i class="fas fa-external-link-alt"></i></a>
            <a class="navbar-item" href="https://www.kubewarden.io" target="_blank"><img src="../../../../_/img/icon-kubewarden-mask.png" width="29" height="24" alt="Kubewarden"
              title="Kubewarden">&nbsp;Kubewarden&nbsp;<i class="fas fa-external-link-alt"></i></a>
            <a class="navbar-item" href="https://harvesterhci.io" target="_blank"><img src="../../../../_/img/icon-harvester-mask.png" width="29" height="24" alt="Harvester"
              title="Harvester">&nbsp;Harvester&nbsp;<i class="fas fa-external-link-alt"></i></a>
            <hr />
            <a class="navbar-item" href="https://opensource.suse.com" target="_blank"><img src="../../../../_/img/icon-suse-mask.png" width="41" height="24" alt="OpenSource at SUSE"
              title="OpenSource @ SUSE">&nbsp;More projects...&nbsp;<i class="fas fa-external-link-alt"></i></a>
          </div>
        </div>
        <div class="navbar-item search hide-for-print">
          <div id="search-field" class="field">
            <input id="search-input" type="text" placeholder="Search the docs" >
          </div>
        </div>
      </div>
    </div>
  </nav>
</header><div class="body">
<noscript>
    <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-57KS2MW"height="0" width="0" style="display:none;visibility:hidden"></iframe>
</noscript>
<div class="nav-container" data-component="turtles" data-version="v0.21">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <button class="nav-menu-toggle" aria-label="Toggle expand/collapse all" style="display: none"></button>
    <h3 class="title"><a href="../index.html">Rancher Turtles</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">Overview</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Tutorials</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../tutorials/quickstart.html">Quick Start</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../tutorials/first-cluster.html">Your First Cluster</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../tutorials/uninstall.html">Uninstall</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Overview</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../overview/architecture.html">Architecture</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../overview/glossary.html">Glossary</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../overview/features.html">Features</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../overview/certified.html">Certified Providers</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Reference</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../reference/capiprovider.html">CAPIProvider</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../reference/clusterctlconfig.html">ClusterctlConfig</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">User Guide</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="clusters.html">Provision a CAPI cluster</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="clusterclass.html">Provision a CAPI cluster with ClusterClass</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="fleet.html">Create a cluster using Fleet</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="delete-cluster.html">Delete an imported cluster</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="caapf.html">CAPI Addon Provider Fleet</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="gitops.html">GitOps best practices for Turtles and CAPI</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Operator Guide</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../operator/chart.html">Chart Configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../operator/manual.html">Manual Installation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../operator/clusterclass.html">Enabling ClusterClass</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../operator/certification.html">Provider Certification</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../operator/certificationsuite.html">Provider Test Suite</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../operator/airgapped.html">Air-Gapped Environment</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Developer Guide</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../developer/development.html">Development Environment</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../developer/guidelines.html">Development Guideline</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Troubleshooting Guide</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../troubleshooting/troubleshooting.html">Troubleshooting</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Security</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../security/slsa.html">SLSA</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../changelogs/index.html">Release Notes</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Rancher Turtles</span>
    <span class="version">v0.21</span>
  </div>
  <ul class="components">
        <li class="component is-current">
          <div class="title"><a href="../../../stable/en/index.html">Rancher Turtles</a></div>
          <ul class="versions">
            <li class="version">
              <a href="../../../next/en/index.html">Next</a>
            </li>
            <li class="version is-latest">
              <a href="../../../stable/en/index.html">v0.24</a>
            </li>
            <li class="version">
              <a href="../../../v0.23/en/index.html">v0.23</a>
            </li>
            <li class="version">
              <a href="../../../v0.22/en/index.html">v0.22</a>
            </li>
            <li class="version is-current">
              <a href="../index.html">v0.21</a>
            </li>
            <li class="version">
              <a href="../../../v0.20/en/index.html">v0.20</a>
            </li>
            <li class="version">
              <a href="../../../v0.19/en/index.html">v0.19</a>
            </li>
            <li class="version">
              <a href="../../../v0.18/en/index.html">v0.18</a>
            </li>
            <li class="version">
              <a href="../../../v0.17/en/index.html">v0.17</a>
            </li>
            <li class="version">
              <a href="../../../v0.16/en/index.html">v0.16</a>
            </li>
            <li class="version">
              <a href="../../../v0.15/en/index.html">v0.15</a>
            </li>
            <li class="version">
              <a href="../../../v0.14/en/index.html">v0.14</a>
            </li>
            <li class="version">
              <a href="../../../v0.13/en/index.html">v0.13</a>
            </li>
            <li class="version">
              <a href="../../../v0.12/en/index.html">v0.12</a>
            </li>
            <li class="version">
              <a href="../../../v0.11/en/index.html">v0.11</a>
            </li>
          </ul>
        </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../../stable/en/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Rancher Turtles</a></li>
    <li>User Guide</li>
    <li><a href="clusterclass.html">Provision a CAPI cluster with ClusterClass</a></li>
  </ul>
</nav>
<div class="page-versions">
  <button class="version-menu-toggle" title="Show other versions of page">v0.21</button>
  <div class="version-menu">
    <a class="version" href="../../../next/en/user/clusterclass.html">Next</a>
    <a class="version" href="../../../stable/en/user/clusterclass.html">v0.24</a>
    <a class="version" href="../../../v0.23/en/user/clusterclass.html">v0.23</a>
    <a class="version" href="../../../v0.22/en/user/clusterclass.html">v0.22</a>
    <a class="version is-current" href="clusterclass.html">v0.21</a>
    <a class="version" href="../../../v0.20/en/user/clusterclass.html">v0.20</a>
    <a class="version" href="../../../v0.19/en/user/clusterclass.html">v0.19</a>
    <a class="version" href="../../../v0.18/en/user/clusterclass.html">v0.18</a>
    <a class="version" href="../../../v0.17/en/user/clusterclass.html">v0.17</a>
    <a class="version is-missing" href="../../../v0.16/en/index.html">v0.16</a>
    <a class="version is-missing" href="../../../v0.15/en/index.html">v0.15</a>
    <a class="version is-missing" href="../../../v0.14/en/index.html">v0.14</a>
    <a class="version is-missing" href="../../../v0.13/en/index.html">v0.13</a>
    <a class="version is-missing" href="../../../v0.12/en/index.html">v0.12</a>
    <a class="version is-missing" href="../../../v0.11/en/index.html">v0.11</a>
  </div>
</div>
<div class="edit-this-page"><a href="https://github.com/rancher/turtles-docs/edit/main/docs/v0.21/modules/en/pages/user/clusterclass.adoc">Edit this Page</a></div>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="4">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">ClusterClass</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>In this section we cover using <a href="https://cluster-api.sigs.k8s.io/tasks/experimental-features/cluster-class/">ClusterClass</a> with Rancher Turtles.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_prerequisites"><a class="anchor" href="#_prerequisites"></a>Prerequisites</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Rancher Manager cluster with Rancher Turtles installed</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_setup"><a class="anchor" href="#_setup"></a>Setup</h2>
<div class="sectionbody">
<div id="_tabs_1" class="openblock tabs is-sync is-loading">
<div class="content">
<div class="ulist tablist">
<ul>
<li id="_tabs_1_azure" class="tab">
<p>Azure</p>
</li>
<li id="_tabs_1_aws" class="tab">
<p>AWS</p>
</li>
<li id="_tabs_1_gcp" class="tab">
<p>GCP</p>
</li>
<li id="_tabs_1_docker" class="tab">
<p>Docker</p>
</li>
<li id="_tabs_1_vsphere" class="tab">
<p>vSphere</p>
</li>
</ul>
</div>
<div id="_tabs_1_azure--panel" class="tabpanel" aria-labelledby="_tabs_1_azure">
<div class="paragraph">
<p>To prepare the management Cluster, we are going to install the <a href="https://capz.sigs.k8s.io/">Cluster API Provider Azure</a>, and create a <a href="https://capz.sigs.k8s.io/topics/identities#service-principal">ServicePrincipal</a> identity to provision a new Cluster on Azure.<br>
Before we start, a ServicePrincipal needs to be created, with at least Contributor access to an Azure subscription.<br>
Refer to the <a href="https://capz.sigs.k8s.io/topics/identities">CAPZ documentation</a> for more details.<br></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Provider installation</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: Namespace
metadata:
  name: capz-system
---
apiVersion: turtles-capi.cattle.io/v1alpha1
kind: CAPIProvider
metadata:
  name: azure
  namespace: capz-system
spec:
  type: infrastructure
  name: azure</code></pre>
</div>
</div>
</li>
<li>
<p><a href="https://github.com/rancher/cluster-api-provider-rke2">Bootstrap/Control Plane provider for RKE2</a>(installed by default) or <a href="https://github.com/kubernetes-sigs/cluster-api">Bootstrap/Control Plane provider for Kubeadm</a>, example of Kubeadm installation:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: Namespace
metadata:
  name: capi-kubeadm-bootstrap-system
---
apiVersion: turtles-capi.cattle.io/v1alpha1
kind: CAPIProvider
metadata:
  name: kubeadm-bootstrap
  namespace: capi-kubeadm-bootstrap-system
spec:
  name: kubeadm
  type: bootstrap
---
apiVersion: v1
kind: Namespace
metadata:
  name: capi-kubeadm-control-plane-system
---
apiVersion: turtles-capi.cattle.io/v1alpha1
kind: CAPIProvider
metadata:
  name: kubeadm-control-plane
  namespace: capi-kubeadm-control-plane-system
spec:
  name: kubeadm
  type: controlPlane</code></pre>
</div>
</div>
</li>
<li>
<p>Identity Setup</p>
<div class="paragraph">
<p>In this example we are going to use an <code>AzureClusterIdentity</code> to provision Azure Clusters.<br>
A Secret containing the Service Principal credentials needs to be created first, to be referenced by the <code>AzureClusterIdentity</code> resource.<br>
Note that the <code>AzureClusterIdentity</code> is a namespaced resource and it needs to be created in the same namespace as the Cluster.<br>
For more information on best practices when using Azure identities, please refer to the official <a href="https://capz.sigs.k8s.io/topics/identities-use-cases">documentation</a>.<br></p>
</div>
<div class="paragraph">
<p>Note that some variables are left to the user to substitute.<br></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: Secret
metadata:
  name: &lt;AZURE_CLUSTER_IDENTITY_SECRET_NAME&gt;
  namespace: &lt;AZURE_CLUSTER_IDENTITY_SECRET_NAMESPACE&gt;
type: Opaque
stringData:
  clientSecret: &lt;AZURE_CLIENT_SECRET&gt;
---
apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
kind: AzureClusterIdentity
metadata:
  labels:
    clusterctl.cluster.x-k8s.io/move-hierarchy: "true"
  name: cluster-identity
spec:
  allowedNamespaces: {}
  clientID: &lt;AZURE_APP_ID&gt;
  clientSecret:
    name: &lt;AZURE_CLUSTER_IDENTITY_SECRET_NAME&gt;
    namespace: &lt;AZURE_CLUSTER_IDENTITY_SECRET_NAMESPACE&gt;
  tenantID: &lt;AZURE_TENANT_ID&gt;
  type: ServicePrincipal</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div id="_tabs_1_aws--panel" class="tabpanel" aria-labelledby="_tabs_1_aws">
<div class="paragraph">
<p>To prepare the management Cluster, we are going to install the <a href="https://cluster-api-aws.sigs.k8s.io/">Cluster API Provider AWS</a>, and create a secret with the required credentials to provision a new Cluster on AWS.<br>
The global credentials are set to blanks, as we are going to use <code>AWSClusterStaticIdentity</code> instead.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Provider installation</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: turtles-capi.cattle.io/v1alpha1
kind: CAPIProvider
metadata:
  name: aws
  namespace: capa-system
spec:
  type: infrastructure
  variables:
    AWS_B64ENCODED_CREDENTIALS: ""</code></pre>
</div>
</div>
</li>
<li>
<p><a href="https://github.com/rancher/cluster-api-provider-rke2">Bootstrap/Control Plane provider for RKE2</a>(installed by default) or <a href="https://github.com/kubernetes-sigs/cluster-api">Bootstrap/Control Plane provider for Kubeadm</a>, example of Kubeadm installation:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: Namespace
metadata:
  name: capi-kubeadm-bootstrap-system
---
apiVersion: turtles-capi.cattle.io/v1alpha1
kind: CAPIProvider
metadata:
  name: kubeadm-bootstrap
  namespace: capi-kubeadm-bootstrap-system
spec:
  name: kubeadm
  type: bootstrap
---
apiVersion: v1
kind: Namespace
metadata:
  name: capi-kubeadm-control-plane-system
---
apiVersion: turtles-capi.cattle.io/v1alpha1
kind: CAPIProvider
metadata:
  name: kubeadm-control-plane
  namespace: capi-kubeadm-control-plane-system
spec:
  name: kubeadm
  type: controlPlane</code></pre>
</div>
</div>
</li>
<li>
<p>Identity Setup</p>
<div class="paragraph">
<p>In this example we are going to use a <code>AWSClusterStaticIdentity</code> to provision AWS Clusters.<br>
A Secret containing the credentials needs to be created in the namespace where the AWS provider is installed.<br>
For more information on how to setup the credentials, refer to the <a href="https://cluster-api-aws.sigs.k8s.io/clusterawsadm/clusterawsadm">clusterawsadm documentation</a>.<br>
The <code>AWSClusterStaticIdentity</code> can reference this Secret to allow Cluster provisioning. For this example we are allowing usage of the identity across all namespaces, so that it can be easily reused.<br>
You can refer to the <a href="https://cluster-api-aws.sigs.k8s.io/topics/multitenancy">official documentation</a> to learn more about identity management.</p>
</div>
<div class="paragraph">
<p>Note that some variables are left to the user to substitute.<br></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: Secret
metadata:
  name: &lt;AWS_IDENTITY_SECRET_NAME&gt;
  namespace: capa-system
type: Opaque
stringData:
  AccessKeyID: &lt;AWS_ACCESS_KEY_ID&gt;
  SecretAccessKey: &lt;AWS_SECRET_ACCESS_KEY&gt;
---
apiVersion: infrastructure.cluster.x-k8s.io/v1beta2
kind: AWSClusterStaticIdentity
metadata:
  name: cluster-identity
spec:
  secretRef: &lt;AWS_IDENTITY_SECRET_NAME&gt;
  allowedNamespaces:
    selector:
      matchLabels: {}</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div id="_tabs_1_gcp--panel" class="tabpanel" aria-labelledby="_tabs_1_gcp">
<div class="paragraph">
<p>To prepare the management Cluster, we are going to install the <a href="https://cluster-api-gcp.sigs.k8s.io/">Cluster API Provider GCP</a>, and create a secret with the credentials required to provision a new Cluster on GCP.<br>
A Service Account is required to create and manage clusters in GCP and this will require <code>Editor</code> permissions. You can follow the offical guide from the <a href="https://cluster-api-gcp.sigs.k8s.io/quick-start#create-a-service-account">CAPG Book</a>.<br>
The base64-encoded Service Account key needs to be set in the <code>GCP_B64ENCODED_CREDENTIALS</code> variable of the provider.<br></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Provider installation</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: turtles-capi.cattle.io/v1alpha1
kind: CAPIProvider
metadata:
  name: gcp
  namespace: capg-system
spec:
  type: infrastructure
  variables:
    GCP_B64ENCODED_CREDENTIALS: xxx</code></pre>
</div>
</div>
</li>
<li>
<p><a href="https://github.com/kubernetes-sigs/cluster-api">Bootstrap/Control Plane provider for Kubeadm</a>, example of Kubeadm installation:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: Namespace
metadata:
  name: capi-kubeadm-bootstrap-system
---
apiVersion: turtles-capi.cattle.io/v1alpha1
kind: CAPIProvider
metadata:
  name: kubeadm-bootstrap
  namespace: capi-kubeadm-bootstrap-system
spec:
  name: kubeadm
  type: bootstrap
---
apiVersion: v1
kind: Namespace
metadata:
  name: capi-kubeadm-control-plane-system
---
apiVersion: turtles-capi.cattle.io/v1alpha1
kind: CAPIProvider
metadata:
  name: kubeadm-control-plane
  namespace: capi-kubeadm-control-plane-system
spec:
  name: kubeadm
  type: controlPlane</code></pre>
</div>
</div>
</li>
<li>
<p>Network Setup</p>
<div class="paragraph">
<p>Provisioning a self-managed GCP cluster requires that a GCP network is configured to allow Kubernetes nodes to communicate with the control plane and pull images from the container registry for which machines need to have NAT access or a public IP.<br>
The default provider behavior is to create virtual machines with no public IP attached, so a <a href="https://cloud.google.com/nat/docs/overview">Cloud NAT</a> is required to allow the nodes to establish a connection with the load balancer and the outside world.<br>
Please, refer to the official <a href="https://cluster-api-gcp.sigs.k8s.io/prerequisites#configure-network-and-cloud-nat">CAPG Book</a> guide on how to prepare your GCP network to provision a self-managed GCP cluster.<br></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The following steps are required to prepare the GCP network for Cluster provisioning:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create a router.</p>
</li>
<li>
<p>Create a NAT associated with the router.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</div>
<div id="_tabs_1_docker--panel" class="tabpanel" aria-labelledby="_tabs_1_docker">
<div class="paragraph">
<p>To prepare the management Cluster, we are going to install the Docker Cluster API Provider.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Infrastructure Docker provider installation</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: Namespace
metadata:
  name: capd-system
---
apiVersion: turtles-capi.cattle.io/v1alpha1
kind: CAPIProvider
metadata:
  name: docker
  namespace: capd-system
spec:
  type: infrastructure</code></pre>
</div>
</div>
</li>
<li>
<p><a href="https://github.com/rancher/cluster-api-provider-rke2">Bootstrap/Control Plane provider for RKE2</a>(installed by default) or <a href="https://github.com/kubernetes-sigs/cluster-api">Bootstrap/Control Plane provider for Kubeadm</a>, example of Kubeadm installation:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: Namespace
metadata:
  name: capi-kubeadm-bootstrap-system
---
apiVersion: turtles-capi.cattle.io/v1alpha1
kind: CAPIProvider
metadata:
  name: kubeadm-bootstrap
  namespace: capi-kubeadm-bootstrap-system
spec:
  name: kubeadm
  type: bootstrap
---
apiVersion: v1
kind: Namespace
metadata:
  name: capi-kubeadm-control-plane-system
---
apiVersion: turtles-capi.cattle.io/v1alpha1
kind: CAPIProvider
metadata:
  name: kubeadm-control-plane
  namespace: capi-kubeadm-control-plane-system
spec:
  name: kubeadm
  type: controlPlane</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div id="_tabs_1_vsphere--panel" class="tabpanel" aria-labelledby="_tabs_1_vsphere">
<div class="paragraph">
<p>To prepare the management Cluster, we are going to install the <a href="https://github.com/kubernetes-sigs/cluster-api-provider-vsphere/blob/main/docs/getting_started.md">Cluster API Provider vSphere</a>.<br>
The global credentials are set to blanks, as we are going to use <code>VSphereClusterIdentity</code> instead.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Provider installation</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: Namespace
metadata:
  name: capv-system
---
apiVersion: turtles-capi.cattle.io/v1alpha1
kind: CAPIProvider
metadata:
  name: vsphere
  namespace: capv-system
spec:
  type: infrastructure
  variables:
    VSPHERE_USERNAME: ""
    VSPHERE_PASSWORD: ""</code></pre>
</div>
</div>
</li>
<li>
<p><a href="https://github.com/rancher/cluster-api-provider-rke2">Bootstrap/Control Plane provider for RKE2</a>(installed by default) or <a href="https://github.com/kubernetes-sigs/cluster-api">Bootstrap/Control Plane provider for Kubeadm</a>, example of Kubeadm installation:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: Namespace
metadata:
  name: capi-kubeadm-bootstrap-system
---
apiVersion: turtles-capi.cattle.io/v1alpha1
kind: CAPIProvider
metadata:
  name: kubeadm-bootstrap
  namespace: capi-kubeadm-bootstrap-system
spec:
  name: kubeadm
  type: bootstrap
---
apiVersion: v1
kind: Namespace
metadata:
  name: capi-kubeadm-control-plane-system
---
apiVersion: turtles-capi.cattle.io/v1alpha1
kind: CAPIProvider
metadata:
  name: kubeadm-control-plane
  namespace: capi-kubeadm-control-plane-system
spec:
  name: kubeadm
  type: controlPlane</code></pre>
</div>
</div>
</li>
<li>
<p>Identity Setup</p>
<div class="paragraph">
<p>In this example we are going to use a <code>VSphereClusterIdentity</code> to provision vSphere Clusters.<br>
A Secret containing the credentials needs to be created in the namespace where the vSphere provider is installed.<br>
The <code>VSphereClusterIdentity</code> can reference this Secret to allow Cluster provisioning. For this example we are allowing usage of the identity across all namespaces, so that it can be easily reused.<br>
You can refer to the <a href="https://github.com/kubernetes-sigs/cluster-api-provider-vsphere/blob/main/docs/identity_management.md">official documentation</a> to learn more about identity management.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: Secret
metadata:
  name: cluster-identity
  namespace: capv-system
type: Opaque
stringData:
  username: xxx
  password: xxx
---
apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
kind: VSphereClusterIdentity
metadata:
  name: cluster-identity
spec:
  secretName: cluster-identity
  allowedNamespaces:
    selector:
      matchLabels: {}</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_create_a_cluster_from_a_clusterclass"><a class="anchor" href="#_create_a_cluster_from_a_clusterclass"></a>Create a Cluster from a ClusterClass</h2>
<div class="sectionbody">
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="ulist">
<ul>
<li>
<p>Examples using <code>HelmApps</code> need at least Rancher <code>v2.11</code>, or otherwise Fleet <code>v0.12</code> or higher.</p>
</li>
<li>
<p>Currently, we only support initial provisioning with 1 control plane replica for Kubeadm providers; this can be later scaled up, <a href="https://github.com/rancher/turtles/issues/1402">refer</a>.<br></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div id="_tabs_2" class="openblock tabs is-sync is-loading">
<div class="content">
<div class="ulist tablist">
<ul>
<li id="_tabs_2_azure_rke2" class="tab">
<p>Azure RKE2</p>
</li>
<li id="_tabs_2_azure_aks" class="tab">
<p>Azure AKS</p>
</li>
<li id="_tabs_2_azure_kubeadm" class="tab">
<p>Azure Kubeadm</p>
</li>
<li id="_tabs_2_aws_kubeadm" class="tab">
<p>AWS Kubeadm</p>
</li>
<li id="_tabs_2_aws_rke2" class="tab">
<p>AWS RKE2</p>
</li>
<li id="_tabs_2_gcp_kubeadm" class="tab">
<p>GCP Kubeadm</p>
</li>
<li id="_tabs_2_docker_kubeadm" class="tab">
<p>Docker Kubeadm</p>
</li>
<li id="_tabs_2_docker_rke2" class="tab">
<p>Docker RKE2</p>
</li>
<li id="_tabs_2_vsphere_kubeadm" class="tab">
<p>vSphere Kubeadm</p>
</li>
<li id="_tabs_2_vsphere_rke2" class="tab">
<p>vSphere RKE2</p>
</li>
</ul>
</div>
<div id="_tabs_2_azure_rke2--panel" class="tabpanel" aria-labelledby="_tabs_2_azure_rke2">
<div class="ulist">
<ul>
<li>
<p>An Azure ClusterClass can be found among the <a href="https://github.com/rancher/turtles/tree/main/examples/clusterclasses">Turtles examples</a>.</p>
<div class="paragraph">
<p>Applications like the Azure Cloud Provider and Calico CNI will be installed on downstream Clusters. This is done automatically at Cluster creation by targeted Clusters with specific labels, such as <code>cloud-provider: azure</code> and <code>cni: calico</code>.<br></p>
</div>
<div id="_tabs_3" class="openblock tabs is-sync is-loading">
<div class="content">
<div class="ulist tablist">
<ul>
<li id="_tabs_3_cli" class="tab">
<p>CLI</p>
</li>
<li id="_tabs_3_kubectl" class="tab">
<p>kubectl</p>
</li>
</ul>
</div>
<div id="_tabs_3_cli--panel" class="tabpanel" aria-labelledby="_tabs_3_cli">
<div class="paragraph">
<p>An Azure RKE2 ClusterClass and associated applications can be applied using the examples tool:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">go run github.com/rancher/turtles/examples@v0.21.0 -r azure-rke2 | kubectl apply -f -</code></pre>
</div>
</div>
</div>
<div id="_tabs_3_kubectl--panel" class="tabpanel" aria-labelledby="_tabs_3_kubectl">
<div class="ulist">
<ul>
<li>
<p>Alternatively, you can apply the Azure RKE2 ClusterClass directly using kubectl:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -f https://raw.githubusercontent.com/rancher/turtles/refs/tags/v0.21.0/examples/clusterclasses/azure/rke2/clusterclass-rke2-example.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Additionally, the <a href="https://capz.sigs.k8s.io/self-managed/cloud-provider-config">Azure Cloud Provider</a> will need to be installed on each downstream Cluster, for the nodes to be initialized correctly.<br>
For this example we are also going to install <a href="https://docs.tigera.io/calico/latest/about/">Calico</a> as the default CNI.<br></p>
<div class="paragraph">
<p>We can do this automatically at Cluster creation using the <a href="https://rancher.github.io/cluster-api-addon-provider-fleet/">Cluster API Add-on Provider Fleet</a>.<br>
This Add-on provider is installed by default with Rancher Turtles.<br>
Two <code>HelmApps</code> need to be created first, to be applied on the new Cluster via label selectors.<br></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -f https://raw.githubusercontent.com/rancher/turtles/refs/tags/v0.21.0/examples/applications/ccm/azure/helm-chart.yaml
kubectl apply -f https://raw.githubusercontent.com/rancher/turtles/refs/tags/v0.21.0/examples/applications/cni/calico/helm-chart.yaml</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
</li>
<li>
<p>Create the Azure Cluster from the example ClusterClass<br></p>
<div class="paragraph">
<p>Note that some variables are left to the user to substitute.<br>
Also beware that the <code>internal-first</code> <code>registrationMethod</code> variable is used as a workaround for correct provisioning.<br>
This immutable variable however will lead to issues when scaling or rolling out control plane nodes.<br>
A <a href="https://github.com/kubernetes-sigs/cluster-api-provider-azure/pull/5525">patch</a> will support this case in a future release of CAPZ, but the Cluster will need to be reprovisioned to change the <code>registrationMethod</code><br></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: cluster.x-k8s.io/v1beta1
kind: Cluster
metadata:
  labels:
    cluster-api.cattle.io/rancher-auto-import: "true"
    cloud-provider: azure
    cni: calico
  name: azure-quickstart
spec:
  clusterNetwork:
    pods:
      cidrBlocks:
      - 192.168.0.0/16
  topology:
    class: azure-rke2-example
    controlPlane:
      replicas: 3
    variables:
    - name: subscriptionID
      value: &lt;AZURE_SUBSCRIPTION_ID&gt;
    - name: location
      value: &lt;AZURE_LOCATION&gt;
    - name: resourceGroup
      value: &lt;AZURE_RESOURCE_GROUP&gt;
    - name: azureClusterIdentityName
      value: cluster-identity
    - name: registrationMethod
      value: internal-first
    version: v1.31.7+rke2r1
    workers:
      machineDeployments:
      - class: rke2-default-worker
        name: md-0
        replicas: 3</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div id="_tabs_2_azure_aks--panel" class="tabpanel" aria-labelledby="_tabs_2_azure_aks">
<div class="ulist">
<ul>
<li>
<p>An Azure AKS ClusterClass can be found among the <a href="https://github.com/rancher/turtles/tree/main/examples/clusterclasses">Turtles examples</a>.</p>
<div id="_tabs_4" class="openblock tabs is-sync is-loading">
<div class="content">
<div class="ulist tablist">
<ul>
<li id="_tabs_4_cli" class="tab">
<p>CLI</p>
</li>
<li id="_tabs_4_kubectl" class="tab">
<p>kubectl</p>
</li>
</ul>
</div>
<div id="_tabs_4_cli--panel" class="tabpanel" aria-labelledby="_tabs_4_cli">
<div class="paragraph">
<p>An Azure AKS ClusterClass and associated applications can be applied using the examples tool:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">go run github.com/rancher/turtles/examples@v0.21.0 -r azure-aks | kubectl apply -f -</code></pre>
</div>
</div>
</div>
<div id="_tabs_4_kubectl--panel" class="tabpanel" aria-labelledby="_tabs_4_kubectl">
<div class="ulist">
<ul>
<li>
<p>Alternatively, you can apply the Azure AKS ClusterClass directly using kubectl:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -f https://raw.githubusercontent.com/rancher/turtles/refs/tags/v0.21.0/examples/clusterclasses/azure/aks/clusterclass-aks-example.yaml</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
</li>
<li>
<p>Create the Azure AKS Cluster from the example ClusterClass<br></p>
<div class="paragraph">
<p>Note that some variables are left to the user to substitute.<br></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: cluster.x-k8s.io/v1beta1
kind: Cluster
metadata:
  labels:
    cluster-api.cattle.io/rancher-auto-import: "true"
  name: azure-aks-quickstart
spec:
  clusterNetwork:
    pods:
      cidrBlocks:
      - 192.168.0.0/16
  topology:
    class: azure-aks-example
    variables:
    - name: subscriptionID
      value: &lt;AZURE_SUBSCRIPTION_ID&gt;
    - name: location
      value: &lt;AZURE_LOCATION&gt;
    - name: resourceGroup
      value: &lt;AZURE_RESOURCE_GROUP&gt;
    - name: azureClusterIdentityName
      value: cluster-identity
    version: v1.31.4
    workers:
      machinePools:
      - class: default-system
        name: system-1
        replicas: 1
      - class: default-worker
        name: worker-1
        replicas: 1</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div id="_tabs_2_azure_kubeadm--panel" class="tabpanel" aria-labelledby="_tabs_2_azure_kubeadm">
<div class="ulist">
<ul>
<li>
<p>An Azure ClusterClass can be found among the <a href="https://github.com/rancher/turtles/tree/main/examples/clusterclasses">Turtles examples</a>.</p>
<div class="paragraph">
<p>Applications like the Azure Cloud Provider and Calico CNI will be installed on downstream Clusters. This is done automatically at Cluster creation by targeted Clusters with specific labels, such as <code>cloud-provider: azure</code> and <code>cni: calico</code>.<br></p>
</div>
<div id="_tabs_5" class="openblock tabs is-sync is-loading">
<div class="content">
<div class="ulist tablist">
<ul>
<li id="_tabs_5_cli" class="tab">
<p>CLI</p>
</li>
<li id="_tabs_5_kubectl" class="tab">
<p>kubectl</p>
</li>
</ul>
</div>
<div id="_tabs_5_cli--panel" class="tabpanel" aria-labelledby="_tabs_5_cli">
<div class="paragraph">
<p>An Azure ClusterClass and associated applications can be applied using the examples tool:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">go run github.com/rancher/turtles/examples@v0.21.0 -r azure-kubeadm | kubectl apply -f -</code></pre>
</div>
</div>
</div>
<div id="_tabs_5_kubectl--panel" class="tabpanel" aria-labelledby="_tabs_5_kubectl">
<div class="ulist">
<ul>
<li>
<p>Alternatively, you can apply the Azure Kubeadm ClusterClass directly using kubectl:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -f https://raw.githubusercontent.com/rancher/turtles/refs/tags/v0.21.0/examples/clusterclasses/azure/kubeadm/clusterclass-kubeadm-example.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Additionally, the <a href="https://capz.sigs.k8s.io/self-managed/cloud-provider-config">Azure Cloud Provider</a> will need to be installed on each downstream Cluster, for the nodes to be initialized correctly.<br>
For this example we are also going to install <a href="https://docs.tigera.io/calico/latest/about/">Calico</a> as the default CNI.<br></p>
<div class="paragraph">
<p>We can do this automatically at Cluster creation using the <a href="https://rancher.github.io/cluster-api-addon-provider-fleet/">Cluster API Add-on Provider Fleet</a>.<br>
This Add-on provider is installed by default with Rancher Turtles.<br>
Two <code>HelmApps</code> need to be created first, to be applied on the new Cluster via label selectors.<br></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -f https://raw.githubusercontent.com/rancher/turtles/refs/tags/v0.21.0/examples/applications/ccm/azure/helm-chart.yaml
kubectl apply -f https://raw.githubusercontent.com/rancher/turtles/refs/tags/v0.21.0/examples/applications/cni/calico/helm-chart.yaml</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
</li>
<li>
<p>Create the Azure Cluster from the example ClusterClass<br></p>
<div class="paragraph">
<p>Note that some variables are left to the user to substitute.<br></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: cluster.x-k8s.io/v1beta1
kind: Cluster
metadata:
  labels:
    cluster-api.cattle.io/rancher-auto-import: "true"
    cloud-provider: azure
    cni: calico
  name: azure-kubeadm-quickstart
spec:
  clusterNetwork:
    pods:
      cidrBlocks:
      - 192.168.0.0/16
  topology:
    class: azure-kubeadm-example
    controlPlane:
      replicas: 1
    variables:
    - name: subscriptionID
      value: &lt;AZURE_SUBSCRIPTION_ID&gt;
    - name: location
      value: &lt;AZURE_LOCATION&gt;
    - name: resourceGroup
      value: &lt;AZURE_RESOURCE_GROUP&gt;
    - name: azureClusterIdentityName
      value: cluster-identity
    version: v1.31.1
    workers:
      machineDeployments:
      - class: kubeadm-default-worker
        name: md-0
        replicas: 1</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div id="_tabs_2_aws_kubeadm--panel" class="tabpanel" aria-labelledby="_tabs_2_aws_kubeadm">
<div class="ulist">
<ul>
<li>
<p>An AWS Kubeadm ClusterClass can be found among the <a href="https://github.com/rancher/turtles/tree/main/examples/clusterclasses">Turtles examples</a>.</p>
<div class="paragraph">
<p>Applications like <a href="https://docs.tigera.io/calico/latest/about/">Calico CNI</a>, <a href="https://github.com/kubernetes/cloud-provider-aws">AWS Cloud Controller Manager</a>, and the <a href="https://github.com/kubernetes-sigs/aws-ebs-csi-driver">AWS EBS CSI Driver</a> will be installed on downstream Clusters. This is done automatically at Cluster creation by targeted Clusters with specific labels, such as <code>cni: calico</code>, <code>cloud-provider: aws</code>, and <code>csi: aws-ebs-csi-driver</code>.</p>
</div>
<div id="_tabs_6" class="openblock tabs is-sync is-loading">
<div class="content">
<div class="ulist tablist">
<ul>
<li id="_tabs_6_cli" class="tab">
<p>CLI</p>
</li>
<li id="_tabs_6_kubectl" class="tab">
<p>kubectl</p>
</li>
</ul>
</div>
<div id="_tabs_6_cli--panel" class="tabpanel" aria-labelledby="_tabs_6_cli">
<div class="paragraph">
<p>An AWS Kubeadm ClusterClass and associated applications can be applied using the examples tool:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">go run github.com/rancher/turtles/examples@v0.21.0 -r aws-kubeadm | kubectl apply -f -</code></pre>
</div>
</div>
</div>
<div id="_tabs_6_kubectl--panel" class="tabpanel" aria-labelledby="_tabs_6_kubectl">
<div class="ulist">
<ul>
<li>
<p>Alternatively, you can apply the AWS Kubeadm ClusterClass directly using kubectl:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -f https://raw.githubusercontent.com/rancher/turtles/refs/tags/v0.21.0/examples/clusterclasses/aws/kubeadm/clusterclass-kubeadm-example.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>For this example we are also going to install <a href="https://docs.tigera.io/calico/latest/about/">Calico</a> as the default CNI.<br></p>
</li>
<li>
<p>The <a href="https://github.com/kubernetes/cloud-provider-aws">AWS Cloud Controller Manager</a> will need to be installed on each downstream Cluster for the nodes to be functional.<br></p>
</li>
<li>
<p>Additionally, we will also enable <a href="https://github.com/kubernetes-sigs/aws-ebs-csi-driver">AWS EBS CSI Driver</a>.<br></p>
<div class="paragraph">
<p>We can do this automatically at Cluster creation using the <a href="https://rancher.github.io/cluster-api-addon-provider-fleet/">Cluster API Add-on Provider Fleet</a>.<br>
This Add-on provider is installed by default with Rancher Turtles.<br>
The <code>HelmApps</code> need to be created first, to be applied on the new Cluster via label selectors. This will take care of deploying Calico, the EBS CSI Driver, and the AWS Cloud Controller Manager in the workload cluster.<br></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -f https://raw.githubusercontent.com/rancher/turtles/refs/tags/v0.21.0/examples/applications/csi/aws/helm-chart.yaml
kubectl apply -f https://raw.githubusercontent.com/rancher/turtles/refs/tags/v0.21.0/examples/applications/cni/aws/calico/helm-chart.yaml
kubectl apply -f https://raw.githubusercontent.com/rancher/turtles/refs/tags/v0.21.0/examples/applications/ccm/aws/helm-chart.yaml</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
</li>
<li>
<p>Create the AWS Cluster from the example ClusterClass<br></p>
<div class="paragraph">
<p>Note that some variables are left to the user to substitute.<br></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: cluster.x-k8s.io/v1beta1
kind: Cluster
metadata:
  labels:
    cluster-api.cattle.io/rancher-auto-import: "true"
    cni: calico
    cloud-provider: aws
    csi: aws-ebs-csi-driver
  name: aws-quickstart
spec:
  clusterNetwork:
    pods:
      cidrBlocks:
      - 192.168.0.0/16
  topology:
    class: aws-kubeadm-example
    controlPlane:
      replicas: 1
    variables:
    - name: region
      value: eu-west-2
    - name: sshKeyName
      value: &lt;AWS_SSH_KEY_NAME&gt;
    - name: controlPlaneMachineType
      value: &lt;AWS_CONTROL_PLANE_MACHINE_TYPE&gt;
    - name: workerMachineType
      value: &lt;AWS_NODE_MACHINE_TYPE&gt;
    - name: awsClusterIdentityName
      value: cluster-identity
    version: v1.31.0
    workers:
      machineDeployments:
      - class: default-worker
        name: md-0
        replicas: 1</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div id="_tabs_2_aws_rke2--panel" class="tabpanel" aria-labelledby="_tabs_2_aws_rke2">
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Before creating an AWS+RKE2 workload cluster, it is required to either build an AMI for the RKE2 version that is going to be installed on the cluster or find one that will work for non-airgapped installations.
You can follow the steps in the <a href="https://github.com/rancher/cluster-api-provider-rke2/tree/main/image-builder#aws">RKE2 image-builder README</a> to build the AMI.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>An AWS RKE2 ClusterClass can be found among the <a href="https://github.com/rancher/turtles/tree/main/examples/clusterclasses">Turtles examples</a>.</p>
<div class="paragraph">
<p>Applications like <a href="https://docs.tigera.io/calico/latest/about/">Calico CNI</a>, <a href="https://github.com/kubernetes/cloud-provider-aws">AWS Cloud Controller Manager</a>, and the <a href="https://github.com/kubernetes-sigs/aws-ebs-csi-driver">AWS EBS CSI Driver</a> will be installed on downstream Clusters. This is done automatically at Cluster creation by targeted Clusters with specific labels, such as <code>cni: calico</code>, <code>cloud-provider: aws</code>, and <code>csi: aws-ebs-csi-driver</code>.</p>
</div>
<div id="_tabs_7" class="openblock tabs is-sync is-loading">
<div class="content">
<div class="ulist tablist">
<ul>
<li id="_tabs_7_cli" class="tab">
<p>CLI</p>
</li>
<li id="_tabs_7_kubectl" class="tab">
<p>kubectl</p>
</li>
</ul>
</div>
<div id="_tabs_7_cli--panel" class="tabpanel" aria-labelledby="_tabs_7_cli">
<div class="paragraph">
<p>An AWS RKE2 ClusterClass and associated applications can be applied using the examples tool:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">go run github.com/rancher/turtles/examples@v0.21.0 -r aws-rke2 | kubectl apply -f -</code></pre>
</div>
</div>
</div>
<div id="_tabs_7_kubectl--panel" class="tabpanel" aria-labelledby="_tabs_7_kubectl">
<div class="ulist">
<ul>
<li>
<p>Alternatively, you can apply the AWS RKE2 ClusterClass directly using kubectl:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -f https://raw.githubusercontent.com/rancher/turtles/refs/tags/v0.21.0/examples/clusterclasses/aws/rke2/clusterclass-ec2-rke2-example.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>For this example we are also going to install <a href="https://docs.tigera.io/calico/latest/about/">Calico</a> as the default CNI.<br></p>
</li>
<li>
<p>The <a href="https://github.com/kubernetes/cloud-provider-aws">AWS Cloud Controller Manager</a> will need to be installed on each downstream Cluster for the nodes to be functional.<br></p>
</li>
<li>
<p>Additionally, we will also enable <a href="https://github.com/kubernetes-sigs/aws-ebs-csi-driver">AWS EBS CSI Driver</a>.<br></p>
<div class="paragraph">
<p>We can do this automatically at Cluster creation using the <a href="https://rancher.github.io/cluster-api-addon-provider-fleet/">Cluster API Add-on Provider Fleet</a>.<br>
This Add-on provider is installed by default with Rancher Turtles.<br>
The <code>HelmApps</code> need to be created first, to be applied on the new Cluster via label selectors. This will take care of deploying Calico, the EBS CSI Driver, and the AWS Cloud Controller Manager in the workload cluster.<br></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -f https://raw.githubusercontent.com/rancher/turtles/refs/tags/v0.21.0/examples/applications/csi/aws/helm-chart.yaml
kubectl apply -f https://raw.githubusercontent.com/rancher/turtles/refs/tags/v0.21.0/examples/applications/cni/aws/calico/helm-chart.yaml
kubectl apply -f https://raw.githubusercontent.com/rancher/turtles/refs/tags/v0.21.0/examples/applications/ccm/aws/helm-chart.yaml</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
</li>
<li>
<p>Create the AWS Cluster from the example ClusterClass<br></p>
<div class="paragraph">
<p>Note that some variables are left to the user to substitute.<br></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: cluster.x-k8s.io/v1beta1
kind: Cluster
metadata:
  labels:
    cloud-provider: aws
    cni: calico
    csi: aws-ebs-csi-driver
    cluster-api.cattle.io/rancher-auto-import: "true"
  name: aws-quickstart
spec:
  clusterNetwork:
    pods:
      cidrBlocks:
      - 192.168.0.0/16
  topology:
    class: aws-rke2-example
    controlPlane:
      replicas: 1
    variables:
    - name: cni
      value: none
    - name: region
      value: &lt;AWS_REGION&gt;
    - name: sshKeyName
      value: &lt;AWS_SSH_KEY_NAME&gt;
    - name: controlPlaneMachineType
      value: &lt;AWS_RKE2_CONTROL_PLANE_MACHINE_TYPE&gt;
    - name: workerMachineType
      value: &lt;AWS_RKE2_NODE_MACHINE_TYPE&gt;
    - name: amiID
      value: &lt;AWS_AMI_ID&gt;
    - name: awsClusterIdentityName
      value: cluster-identity
    version: v1.31.7+rke2r1
    workers:
      machineDeployments:
      - class: default-worker
        name: md-0
        replicas: 1</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div id="_tabs_2_gcp_kubeadm--panel" class="tabpanel" aria-labelledby="_tabs_2_gcp_kubeadm">
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Before creating a GCP+Kubeadm workload cluster, it is required to either build an Image for the Kubernetes version that is going to be installed on the cluster or find one that will work for your use case.
You can follow the steps in the <a href="https://image-builder.sigs.k8s.io/capi/providers/gcp">Kubernetes GCP Image Builder book</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>A GCP Kubeadm ClusterClass can be found among the <a href="https://github.com/rancher/turtles/tree/main/examples/clusterclasses">Turtles examples</a>.</p>
<div class="paragraph">
<p>Applications like <a href="https://docs.tigera.io/calico/latest/about/">Calico CNI</a> and <a href="https://github.com/kubernetes/cloud-provider-gcp">GCP Cloud Controller Manager</a> will be installed on downstream Clusters. This is done automatically at Cluster creation by targeted Clusters with specific labels, such as <code>cni: calico</code> and <code>cloud-provider: gcp</code>.</p>
</div>
<div id="_tabs_8" class="openblock tabs is-sync is-loading">
<div class="content">
<div class="ulist tablist">
<ul>
<li id="_tabs_8_cli" class="tab">
<p>CLI</p>
</li>
<li id="_tabs_8_kubectl" class="tab">
<p>kubectl</p>
</li>
</ul>
</div>
<div id="_tabs_8_cli--panel" class="tabpanel" aria-labelledby="_tabs_8_cli">
<div class="paragraph">
<p>A GCP Kubeadm ClusterClass and associated applications can be applied using the examples tool:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">go run github.com/rancher/turtles/examples@v0.21.0 -r gcp-kubeadm | kubectl apply -f -</code></pre>
</div>
</div>
</div>
<div id="_tabs_8_kubectl--panel" class="tabpanel" aria-labelledby="_tabs_8_kubectl">
<div class="ulist">
<ul>
<li>
<p>Alternatively, you can apply the GCP Kubeadm ClusterClass directly using kubectl:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -f https://raw.githubusercontent.com/rancher/turtles/refs/tags/v0.21.0/examples/clusterclasses/gcp/kubeadm/clusterclass-kubeadm-example.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>For this example we are also going to install <a href="https://docs.tigera.io/calico/latest/about/">Calico</a> as the default CNI.<br></p>
</li>
<li>
<p>The <a href="https://github.com/kubernetes/cloud-provider-gcp">GCP Cloud Controller Manager</a> will need to be installed on each downstream Cluster for the nodes to be functional.<br></p>
<div class="paragraph">
<p>We can do this automatically at Cluster creation using a combination of <a href="https://rancher.github.io/cluster-api-addon-provider-fleet/">Cluster API Add-on Provider Fleet</a> and <a href="https://fleet.rancher.io/bundle-add">Fleet Bundle</a>.<br>
The Add-on provider is installed by default with Rancher Turtles.<br>
The <code>HelmApps</code> need to be created first, to be applied on the new Cluster via label selectors. This will take care of deploying Calico.<br></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -f https://raw.githubusercontent.com/rancher/turtles/refs/tags/v0.21.0/examples/applications/cni/calico/helm-chart.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>A <code>Bundle</code> will take care of deploying GCP Cloud Controller Manager. The reason for not using Add-on Provider Fleet is that <a href="https://github.com/kubernetes/cloud-provider-gcp">GCP Cloud Controller Manager</a> does not provide a Helm chart, so we opt for creating the Fleet <code>Bundle</code> resource directly.<br></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -f https://raw.githubusercontent.com/rancher/turtles/refs/tags/v0.21.0/examples/applications/ccm/gcp/bundle.yaml</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
</li>
<li>
<p>Create the GCP Cluster from the example ClusterClass<br></p>
<div class="paragraph">
<p>Note that some variables are left to the user to substitute.<br>
The default configuration of GCP Cloud Controller Manager is configured to use a single zone cluster, so the <code>clusterFailureDomains</code> variable is set to a single zone. If you need to provision a multi-zone cluster, we recommend you inspect the parameters provided by <a href="https://github.com/kubernetes/cloud-provider-gcp/blob/master/providers/gce/gce.go#L120">GCP Cloud Controller Manager</a> and how <a href="https://github.com/kubernetes-sigs/cluster-api-provider-gcp/blob/main/test/e2e/data/infrastructure-gcp/cluster-template-ci.yaml#L59">CAPG leverages these variables</a> to create cluster-specific configurations.<br></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: cluster.x-k8s.io/v1beta1
kind: Cluster
metadata:
  labels:
    cluster-api.cattle.io/rancher-auto-import: "true"
    cni: calico
    cloud-provider: gcp
  name: gcp-quickstart
spec:
  clusterNetwork:
    pods:
      cidrBlocks:
      - 192.168.0.0/16
  topology:
    class: gcp-kubeadm-example
    controlPlane:
      replicas: 1
    workers:
      machineDeployments:
        - class: "default-worker"
          name: "md-0"
          replicas: 1
    variables:
      - name: gcpProject
        value: &lt;GCP_PROJECT&gt;
      - name: region
        value: &lt;GCP_REGION&gt;
      - name: gcpNetworkName
        value: &lt;GCP_NETWORK_NAME&gt;
      - name: clusterFailureDomains
        value:
          - "&lt;GCP_REGION&gt;-a"
      - name: imageId
        value: &lt;GCP_IMAGE_ID&gt;
      - name: machineType
        value: &lt;GCP_MACHINE_TYPE&gt;
    version: v1.31.4</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div id="_tabs_2_docker_kubeadm--panel" class="tabpanel" aria-labelledby="_tabs_2_docker_kubeadm">
<div class="ulist">
<ul>
<li>
<p>A Docker Kubeadm ClusterClass can be found among the <a href="https://github.com/rancher/turtles/tree/main/examples/clusterclasses">Turtles examples</a>.</p>
<div class="paragraph">
<p>Applications like <a href="https://docs.tigera.io/calico/latest/about/">Calico CNI</a> will be installed on downstream Clusters. This is done automatically at Cluster creation by targeted Clusters with specific labels, such as <code>cni: calico</code>.</p>
</div>
<div id="_tabs_9" class="openblock tabs is-sync is-loading">
<div class="content">
<div class="ulist tablist">
<ul>
<li id="_tabs_9_cli" class="tab">
<p>CLI</p>
</li>
<li id="_tabs_9_kubectl" class="tab">
<p>kubectl</p>
</li>
</ul>
</div>
<div id="_tabs_9_cli--panel" class="tabpanel" aria-labelledby="_tabs_9_cli">
<div class="paragraph">
<p>A Docker Kubeadm ClusterClass and associated applications can be applied using the examples tool:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">go run github.com/rancher/turtles/examples@v0.21.0 -r docker-kubeadm | kubectl apply -f -</code></pre>
</div>
</div>
</div>
<div id="_tabs_9_kubectl--panel" class="tabpanel" aria-labelledby="_tabs_9_kubectl">
<div class="ulist">
<ul>
<li>
<p>Alternatively, you can apply the Docker Kubeadm ClusterClass directly using kubectl:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -f https://raw.githubusercontent.com/rancher/turtles/refs/tags/v0.21.0/examples/clusterclasses/docker/kubeadm/clusterclass-docker-kubeadm.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>For this example we are also going to install Calico as the default CNI.</p>
<div class="paragraph">
<p>We can do this automatically at Cluster creation using the <a href="https://rancher.github.io/cluster-api-addon-provider-fleet/">Cluster API Add-on Provider Fleet</a>.<br>
This Add-on provider is installed by default with Rancher Turtles.<br>
Two <code>HelmApps</code> need to be created first, to be applied on the new Cluster via label selectors.<br></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -f https://raw.githubusercontent.com/rancher/turtles/refs/tags/v0.21.0/examples/applications/cni/calico/helm-chart.yaml</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
</li>
<li>
<p>Create the Docker Kubeadm Cluster from the example ClusterClass<br></p>
<div class="paragraph">
<p>Note that some variables are left to the user to substitute.<br></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: cluster.x-k8s.io/v1beta1
kind: Cluster
metadata:
  name: docker-kubeadm-quickstart
  labels:
    cni: calico
spec:
  clusterNetwork:
    pods:
      cidrBlocks:
        - 192.168.0.0/16
    serviceDomain: cluster.local
    services:
      cidrBlocks:
        - 10.96.0.0/24
  topology:
    class: docker-kubeadm-example
    controlPlane:
      replicas: 3
    version: v1.31.4
    workers:
      machineDeployments:
        - class: default-worker
          name: md-0
          replicas: 3</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div id="_tabs_2_docker_rke2--panel" class="tabpanel" aria-labelledby="_tabs_2_docker_rke2">
<div class="ulist">
<ul>
<li>
<p>A Docker RKE2 ClusterClass can be found among the <a href="https://github.com/rancher/turtles/tree/main/examples/clusterclasses">Turtles examples</a>.</p>
<div class="paragraph">
<p>Applications like <a href="https://docs.tigera.io/calico/latest/about/">Calico CNI</a> will be installed on downstream Clusters. This is done automatically at Cluster creation by targeted Clusters with specific labels, such as <code>cni: calico</code>.</p>
</div>
<div id="_tabs_10" class="openblock tabs is-sync is-loading">
<div class="content">
<div class="ulist tablist">
<ul>
<li id="_tabs_10_cli" class="tab">
<p>CLI</p>
</li>
<li id="_tabs_10_kubectl" class="tab">
<p>kubectl</p>
</li>
</ul>
</div>
<div id="_tabs_10_cli--panel" class="tabpanel" aria-labelledby="_tabs_10_cli">
<div class="paragraph">
<p>A Docker RKE2 ClusterClass and associated applications can be applied using the examples tool:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">go run github.com/rancher/turtles/examples@v0.21.0 -r docker-rke2 | kubectl apply -f -</code></pre>
</div>
</div>
</div>
<div id="_tabs_10_kubectl--panel" class="tabpanel" aria-labelledby="_tabs_10_kubectl">
<div class="ulist">
<ul>
<li>
<p>Alternatively, you can apply the Docker RKE2 ClusterClass directly using kubectl:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -f https://raw.githubusercontent.com/rancher/turtles/refs/tags/v0.21.0/examples/clusterclasses/docker/rke2/clusterclass-docker-rke2.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>For this example we are also going to install Calico as the default CNI.</p>
<div class="paragraph">
<p>We can do this automatically at Cluster creation using the <a href="https://rancher.github.io/cluster-api-addon-provider-fleet/">Cluster API Add-on Provider Fleet</a>.<br>
This Add-on provider is installed by default with Rancher Turtles.<br>
Two <code>HelmApps</code> need to be created first, to be applied on the new Cluster via label selectors.<br></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -f https://raw.githubusercontent.com/rancher/turtles/refs/tags/v0.21.0/examples/applications/cni/calico/helm-chart.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Create the LoadBalancer ConfigMap for Docker RKEv2 Cluster<br></p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -f https://raw.githubusercontent.com/rancher/turtles/refs/tags/v0.21.0/examples/applications/lb/docker/configmap.yaml</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
</li>
<li>
<p>Create the Docker Kubeadm Cluster from the example ClusterClass<br></p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: cluster.x-k8s.io/v1beta1
kind: Cluster
metadata:
  name: docker-rke2-example
  labels:
    cni: calico
  annotations:
    cluster-api.cattle.io/upstream-system-agent: "true"
spec:
  clusterNetwork:
    pods:
      cidrBlocks:
      - 192.168.0.0/16
    services:
      cidrBlocks:
      - 10.96.0.0/24
    serviceDomain: cluster.local
  topology:
    class: docker-rke2-example
    controlPlane:
      replicas: 3
    variables:
    - name: rke2CNI
      value: none
    - name: dockerImage
      value: kindest/node:v1.31.6
    version: v1.31.7+rke2r1
    workers:
      machineDeployments:
      - class: default-worker
        name: md-0
        replicas: 3</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div id="_tabs_2_vsphere_kubeadm--panel" class="tabpanel" aria-labelledby="_tabs_2_vsphere_kubeadm">
<div class="ulist">
<ul>
<li>
<p>A vSphere ClusterClass can be found among the <a href="https://github.com/rancher/turtles/tree/main/examples/clusterclasses">Turtles examples</a>.</p>
<div class="paragraph">
<p>Applications like the vSphere Cloud Provider, vSphere CSI driver, and Calico CNI will be installed on downstream Clusters. This is done automatically at Cluster creation by targeted Clusters with specific labels, such as <code>cloud-provider: vsphere</code>, <code>csi: vsphere</code>, and <code>cni: calico</code>.<br></p>
</div>
<div id="_tabs_11" class="openblock tabs is-sync is-loading">
<div class="content">
<div class="ulist tablist">
<ul>
<li id="_tabs_11_cli" class="tab">
<p>CLI</p>
</li>
<li id="_tabs_11_kubectl" class="tab">
<p>kubectl</p>
</li>
</ul>
</div>
<div id="_tabs_11_cli--panel" class="tabpanel" aria-labelledby="_tabs_11_cli">
<div class="paragraph">
<p>A vSphere Kubeadm ClusterClass and associated applications can be applied using the examples tool:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">go run github.com/rancher/turtles/examples@v0.21.0 -r vsphere-kubeadm | kubectl apply -f -</code></pre>
</div>
</div>
</div>
<div id="_tabs_11_kubectl--panel" class="tabpanel" aria-labelledby="_tabs_11_kubectl">
<div class="ulist">
<ul>
<li>
<p>Alternatively, you can apply the vSphere Kubeadm ClusterClass directly using kubectl:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -f https://raw.githubusercontent.com/rancher/turtles/refs/tags/v0.21.0/examples/clusterclasses/vsphere/kubeadm/clusterclass-kubeadm-example.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Additionally, the <a href="https://github.com/kubernetes/cloud-provider-vsphere">vSphere Cloud Provider</a> will need to be installed on each downstream Cluster, for the nodes to be initialized correctly.<br>
The <a href="https://github.com/kubernetes-sigs/vsphere-csi-driver">Container Storage Interface (CSI) driver for vSphere</a> will be used as storage solution.<br>
Finally, for this example we are going to install <a href="https://docs.tigera.io/calico/latest/about/">Calico</a> as the default CNI.<br></p>
<div class="paragraph">
<p>We can install all applications automatically at Cluster creation using the <a href="https://rancher.github.io/cluster-api-addon-provider-fleet/">Cluster API Add-on Provider Fleet</a>.<br>
This Add-on provider is installed by default with Rancher Turtles.<br>
Two <code>HelmApps</code> need to be created first, to be applied on the new Cluster via label selectors.<br></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -f https://raw.githubusercontent.com/rancher/turtles/refs/tags/v0.21.0/examples/applications/ccm/vsphere/helm-chart.yaml
kubectl apply -f https://raw.githubusercontent.com/rancher/turtles/refs/tags/v0.21.0/examples/applications/cni/calico/helm-chart.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Since the vSphere CSI driver is not packaged in Helm, we are going to include its entire manifest in a Fleet Bundle, that will be applied to the downstream Cluster.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -f https://raw.githubusercontent.com/rancher/turtles/refs/tags/v0.21.0/examples/applications/csi/vsphere/bundle.yaml</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
</li>
<li>
<p>Cluster configuration</p>
<div class="paragraph">
<p>The vSphere Cloud Provider and the vSphere CSI controller need additional configuration to be applied on the downstream Cluster.<br>
Similarly to the steps above, we can create two additional Fleet Bundles, that will be applied to the downstream Cluster.<br>
Please beware that these Bundles are configured to target the downstream Cluster by name: <code>vsphere-kubeadm-quickstart</code>.<br>
If you use a different name for your Cluster, change the Bundle targets accordingly.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">kind: Bundle
apiVersion: fleet.cattle.io/v1alpha1
metadata:
  name: vsphere-csi-config
spec:
  resources:
  - content: |-
      apiVersion: v1
      kind: Secret
      type: Opaque
      metadata:
        name: vsphere-config-secret
        namespace: vmware-system-csi
      stringData:
        csi-vsphere.conf: |+
          [Global]
          thumbprint = "&lt;VSPHERE_THUMBPRINT&gt;"

          [VirtualCenter "&lt;VSPHERE_SERVER&gt;"]
          user = "&lt;VSPHERE_USER&gt;"
          password = "&lt;VSPHERE_PASSWORD&gt;"
          datacenters = "&lt;VSPHERE_DATACENTED&gt;"

          [Network]
          public-network = "&lt;VSPHERE_NETWORK&gt;"

          [Labels]
          zone = ""
          region = ""
  targets:
  - clusterSelector:
      matchLabels:
        csi: vsphere
        cluster.x-k8s.io/cluster-name: 'vsphere-kubeadm-quickstart'
---
kind: Bundle
apiVersion: fleet.cattle.io/v1alpha1
metadata:
  name: vsphere-cloud-credentials
spec:
  resources:
  - content: |-
      apiVersion: v1
      kind: Secret
      type: Opaque
      metadata:
        name: vsphere-cloud-secret
        namespace: kube-system
      stringData:
        &lt;VSPHERE_SERVER&gt;.password: "&lt;VSPHERE_PASSWORD&gt;"
        &lt;VSPHERE_SERVER&gt;.username: "&lt;VSPHERE_USER&gt;"
  targets:
  - clusterSelector:
      matchLabels:
        cloud-provider: vsphere
        cluster.x-k8s.io/cluster-name: 'vsphere-kubeadm-quickstart'</code></pre>
</div>
</div>
</li>
<li>
<p>Create the vSphere Cluster from the example ClusterClass<br></p>
<div class="paragraph">
<p>Note that for this example we are using <a href="https://kube-vip.io/">kube-vip</a> as a Control Plane load balancer.<br>
The <code>KUBE_VIP_INTERFACE</code> will be used to bind the <code>CONTROL_PLANE_IP</code> in ARP mode. Depending on your operating system and network device configuration, you need to configure this value accordingly - for example, to <code>eth0</code>.<br>
The <code>kube-vip</code> static manifest is embedded in the ClusterClass definition. For more information on how to generate a static kube-vip manifest for your own ClusterClasses, please consult the official <a href="https://kube-vip.io/docs/installation/static/">documentation</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: cluster.x-k8s.io/v1beta1
kind: Cluster
metadata:
  labels:
    cni: calico
    cloud-provider: vsphere
    csi: vsphere
    cluster-api.cattle.io/rancher-auto-import: "true"
  name: 'vsphere-kubeadm-quickstart'
spec:
  clusterNetwork:
    pods:
      cidrBlocks:
      - 192.168.0.0/16
  topology:
    class: vsphere-kubeadm-example
    version: v1.31.4
    controlPlane:
      replicas: 1
    workers:
      machineDeployments:
      - class: vsphere-kubeadm-example-worker
        name: md-0
        replicas: 1
    variables:
    - name: vSphereClusterIdentityName
      value: cluster-identity
    - name: vSphereTLSThumbprint
      value: &lt;VSPHERE_THUMBPRINT&gt;
    - name: vSphereDataCenter
      value: &lt;VSPHERE_DATACENTER&gt;
    - name: vSphereDataStore
      value: &lt;VSPHERE_DATASTORE&gt;
    - name: vSphereFolder
      value: &lt;VSPHERE_FOLDER&gt;
    - name: vSphereNetwork
      value: &lt;VSPHERE_NETWORK&gt;
    - name: vSphereResourcePool
      value: &lt;VSPHERE_RESOURCE_POOL&gt;
    - name: vSphereServer
      value: &lt;VSPHERE_SERVER&gt;
    - name: vSphereTemplate
      value: &lt;VSPHERE_TEMPLATE&gt;
    - name: controlPlaneIpAddr
      value: &lt;CONTROL_PLANE_IP&gt;
    - name: controlPlanePort
      value: 6443
    - name: sshKey
      value: &lt;SSH_KEY&gt;
    - name: kubeVIPInterface
      value: &lt;KUBE_VIP_INTERFACE&gt;</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div id="_tabs_2_vsphere_rke2--panel" class="tabpanel" aria-labelledby="_tabs_2_vsphere_rke2">
<div class="ulist">
<ul>
<li>
<p>A vSphere ClusterClass can be found among the <a href="https://github.com/rancher/turtles/tree/main/examples/clusterclasses">Turtles examples</a>.</p>
<div class="paragraph">
<p>Applications like the vSphere Cloud Provider, vSphere CSI driver, and Calico CNI will be installed on downstream Clusters. This is done automatically at Cluster creation by targeted Clusters with specific labels, such as <code>cloud-provider: vsphere</code>, <code>csi: vsphere</code>, and <code>cni: calico</code>.<br></p>
</div>
<div id="_tabs_12" class="openblock tabs is-sync is-loading">
<div class="content">
<div class="ulist tablist">
<ul>
<li id="_tabs_12_cli" class="tab">
<p>CLI</p>
</li>
<li id="_tabs_12_kubectl" class="tab">
<p>kubectl</p>
</li>
</ul>
</div>
<div id="_tabs_12_cli--panel" class="tabpanel" aria-labelledby="_tabs_12_cli">
<div class="paragraph">
<p>A vSphere RKE2 ClusterClass and associated applications can be applied using the examples tool:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">go run github.com/rancher/turtles/examples@v0.21.0 -r vsphere-rke2 | kubectl apply -f -</code></pre>
</div>
</div>
</div>
<div id="_tabs_12_kubectl--panel" class="tabpanel" aria-labelledby="_tabs_12_kubectl">
<div class="ulist">
<ul>
<li>
<p>Alternatively, you can apply the vSphere RKE2 ClusterClass directly using kubectl:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -f https://raw.githubusercontent.com/rancher/turtles/refs/tags/v0.21.0/examples/clusterclasses/vsphere/rke2/clusterclass-rke2-example.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Additionally, the <a href="https://github.com/kubernetes/cloud-provider-vsphere">vSphere Cloud Provider</a> will need to be installed on each downstream Cluster, for the nodes to be initialized correctly.<br>
The <a href="https://github.com/kubernetes-sigs/vsphere-csi-driver">Container Storage Interface (CSI) driver for vSphere</a> will be used as storage solution.<br>
Finally, for this example we are going to install <a href="https://docs.tigera.io/calico/latest/about/">Calico</a> as the default CNI.<br></p>
<div class="paragraph">
<p>We can install all applications automatically at Cluster creation using the <a href="https://rancher.github.io/cluster-api-addon-provider-fleet/">Cluster API Add-on Provider Fleet</a>.<br>
This Add-on provider is installed by default with Rancher Turtles.<br>
Two <code>HelmApps</code> need to be created first, to be applied on the new Cluster via label selectors.<br></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -f https://raw.githubusercontent.com/rancher/turtles/refs/tags/v0.21.0/examples/applications/ccm/vsphere/helm-chart.yaml
kubectl apply -f https://raw.githubusercontent.com/rancher/turtles/refs/tags/v0.21.0/examples/applications/cni/calico/helm-chart.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Since the vSphere CSI driver is not packaged in Helm, we are going to include its entire manifest in a Fleet Bundle, that will be applied to the downstream Cluster.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -f https://raw.githubusercontent.com/rancher/turtles/refs/tags/v0.21.0/examples/applications/csi/vsphere/bundle.yaml</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
</li>
<li>
<p>Cluster configuration</p>
<div class="paragraph">
<p>The vSphere Cloud Provider and the vSphere CSI controller need additional configuration to be applied on the downstream Cluster.<br>
Similarly to the steps above, we can create two additional Fleet Bundles, that will be applied to the downstream Cluster.<br>
Please beware that these Bundles are configured to target the downstream Cluster by name: <code>vsphere-rke2-quickstart</code>.<br>
If you use a different name for your Cluster, change the Bundle targets accordingly.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">kind: Bundle
apiVersion: fleet.cattle.io/v1alpha1
metadata:
  name: vsphere-csi-config
spec:
  resources:
  - content: |-
      apiVersion: v1
      kind: Secret
      type: Opaque
      metadata:
        name: vsphere-config-secret
        namespace: vmware-system-csi
      stringData:
        csi-vsphere.conf: |+
          [Global]
          thumbprint = "&lt;VSPHERE_THUMBPRINT&gt;"

          [VirtualCenter "&lt;VSPHERE_SERVER&gt;"]
          user = "&lt;VSPHERE_USER&gt;"
          password = "&lt;VSPHERE_PASSWORD&gt;"
          datacenters = "&lt;VSPHERE_DATACENTED&gt;"

          [Network]
          public-network = "&lt;VSPHERE_NETWORK&gt;"

          [Labels]
          zone = ""
          region = ""
  targets:
  - clusterSelector:
      matchLabels:
        csi: vsphere
        cluster.x-k8s.io/cluster-name: 'vsphere-rke2-quickstart'
---
kind: Bundle
apiVersion: fleet.cattle.io/v1alpha1
metadata:
  name: vsphere-cloud-credentials
spec:
  resources:
  - content: |-
      apiVersion: v1
      kind: Secret
      type: Opaque
      metadata:
        name: vsphere-cloud-secret
        namespace: kube-system
      stringData:
        &lt;VSPHERE_SERVER&gt;.password: "&lt;VSPHERE_PASSWORD&gt;"
        &lt;VSPHERE_SERVER&gt;.username: "&lt;VSPHERE_USER&gt;"
  targets:
  - clusterSelector:
      matchLabels:
        cloud-provider: vsphere
        cluster.x-k8s.io/cluster-name: 'vsphere-rke2-quickstart'</code></pre>
</div>
</div>
</li>
<li>
<p>Create the vSphere Cluster from the example ClusterClass<br></p>
<div class="paragraph">
<p>Note that for this example we are using <a href="https://kube-vip.io/">kube-vip</a> as a Control Plane load balancer.<br>
The <code>KUBE_VIP_INTERFACE</code> will be used to bind the <code>CONTROL_PLANE_IP</code> in ARP mode. Depending on your operating system and network device configuration, you need to configure this value accordingly - for example, to <code>eth0</code>.<br>
The <code>kube-vip</code> static manifest is embedded in the ClusterClass definition. For more information on how to generate a static kube-vip manifest for your own ClusterClasses, please consult the official <a href="https://kube-vip.io/docs/installation/static/">documentation</a>.<br>
In case you are using a VM template based on SUSE Linux Micro, you may optionally provide a <code>productKey</code> variable to enable automatic SL Micro registration against SUSE Customer Center.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: cluster.x-k8s.io/v1beta1
kind: Cluster
metadata:
  labels:
    cni: calico
    cloud-provider: vsphere
    csi: vsphere
    cluster-api.cattle.io/rancher-auto-import: "true"
  name: 'vsphere-rke2-quickstart'
spec:
  clusterNetwork:
    pods:
      cidrBlocks:
      - 192.168.0.0/16
  topology:
    class: vsphere-rke2-example
    version: v1.31.7+rke2r1
    controlPlane:
      replicas: 1
    workers:
      machineDeployments:
      - class: vsphere-rke2-example-worker
        name: md-0
        replicas: 1
    variables:
    - name: vSphereClusterIdentityName
      value: cluster-identity
    - name: vSphereTLSThumbprint
      value: &lt;VSPHERE_THUMBPRINT&gt;
    - name: vSphereDataCenter
      value: &lt;VSPHERE_DATACENTER&gt;
    - name: vSphereDataStore
      value: &lt;VSPHERE_DATASTORE&gt;
    - name: vSphereFolder
      value: &lt;VSPHERE_FOLDER&gt;
    - name: vSphereNetwork
      value: &lt;VSPHERE_NETWORK&gt;
    - name: vSphereResourcePool
      value: &lt;VSPHERE_RESOURCE_POOL&gt;
    - name: vSphereServer
      value: &lt;VSPHERE_SERVER&gt;
    - name: vSphereTemplate
      value: &lt;VSPHERE_TEMPLATE&gt;
    - name: controlPlaneIpAddr
      value: &lt;CONTROL_PLANE_IP&gt;
    - name: controlPlanePort
      value: 6443
    - name: sshKey
      value: &lt;SSH_KEY&gt;
    - name: kubeVIPInterface
      value: &lt;KUBE_VIP_INTERFACE&gt;
    - name: productKey
      value: &lt;SL_MICRO_PRODUCT_KEY&gt;</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_optionally_mark_namespace_for_auto_import"><a class="anchor" href="#_optionally_mark_namespace_for_auto_import"></a>Optionally Mark Namespace for Auto-Import</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To automatically import a CAPI cluster into Rancher Manager, you can label a namespace so all clusters contained in it are imported.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">export NAMESPACE=default
kubectl label namespace $NAMESPACE cluster-api.cattle.io/rancher-auto-import=true</code></pre>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="clusters.html">Provision a CAPI cluster</a></span>
  <span class="next"><a href="fleet.html">Create a cluster using Fleet</a></span>
</nav>
</article>
  </div>
</main>
</div><script src="../../../../_/js/site.js"></script>
<script async src="../../../../_/js/vendor/highlight.js"></script>
<script src="../../../../_/js/vendor/lunr.js"></script>
<script src="../../../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../../../.." data-snippet-length="100" data-stylesheet="../../../../_/css/search.css"></script>
<script async src="../../../../search-index.js"></script>
<script src="../../../../_/js/vendor/langSelection.js"></script>
<script async src="../../../../_/js/vendor/tabs.js"></script>


  </body>
</html>
